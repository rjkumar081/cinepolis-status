<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cinepolis Uptime Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; transition: background 0.5s; color: #fff; padding: 20px; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  th, td { padding: 10px; text-align: left; }
  th { background: rgba(0,0,0,0.3); }
  .status-up { color: #00ff00; font-weight: bold; }
  .status-down { color: #ff4444; font-weight: bold; }
  #time { font-size: 1.2em; margin-bottom: 20px; }
  canvas { background: rgba(0,0,0,0.2); border-radius: 8px; }
</style>
</head>
<body>

<h1>Cinepolis Uptime Dashboard</h1>
<div id="time"></div>

<table>
  <thead>
    <tr>
      <th>Website</th>
      <th>Status</th>
      <th>Response Time (ms)</th>
      <th>Uptime %</th>
    </tr>
  </thead>
  <tbody id="status-table">
    <tr><td colspan="4">Loading...</td></tr>
  </tbody>
</table>

<canvas id="uptimeChart" height="100"></canvas>
<canvas id="responseChart" height="100" style="margin-top:20px;"></canvas>

<script>
const FAILURE_TOLERANCE = 1; // matches workflow

async function loadStatus() {
  const table = document.getElementById('status-table');
  table.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

  try {
    const response = await fetch('status.json', {cache:"no-store"});
    const log = await response.json();

    if (!log.length) return;

    // Apply failure tolerance
    const recent = log.slice(-FAILURE_TOLERANCE-1);
    const failCount = recent.filter(e => e.status !== "UP").length;
    const finalStatus = (failCount > FAILURE_TOLERANCE) ? "DOWN" : "UP";

    // Latest entry
    const latest = log[log.length-1];
    const statusClass = finalStatus.toLowerCase() === 'up' ? 'status-up' : 'status-down';
    table.innerHTML = `<tr>
      <td>${latest.website || 'Website'}</td>
      <td class="${statusClass}">${finalStatus}</td>
      <td>${latest.response_time}</td>
      <td>${((log.filter(e => e.status==="UP").length/log.length)*100).toFixed(2)}%</td>
    </tr>`;

    // Dynamic background
    document.body.style.background = finalStatus==='UP' 
      ? 'linear-gradient(to right, #1f4037, #99f2c8)' 
      : 'linear-gradient(to right, #b71c1c, #f44336)';

    // Charts
    const lastN = 20;
    const recentLogs = log.slice(-lastN);
    const labels = recentLogs.map((e,i)=>i+1);
    
    uptimeChart.data.labels = labels;
    uptimeChart.data.datasets = [{
      label: 'Uptime %',
      data: recentLogs.map(e => e.status==='UP'?100:0),
      borderColor: 'lime',
      fill:false,
      tension:0.3
    }];
    uptimeChart.update();

    responseChart.data.labels = labels;
    responseChart.data.datasets = [{
      label: 'Response Time (ms)',
      data: recentLogs.map(e => e.response_time),
      borderColor: 'cyan',
      fill:false,
      tension:0.3
    }];
    responseChart.update();

  } catch(err) {
    table.innerHTML = `<tr><td colspan="4" style="color:red;">Error loading status.json</td></tr>`;
    console.error(err);
  }
}

// India time display
function updateTime() {
  const now = new Date();
  const indiaTime = now.toLocaleString("en-IN", {timeZone: "Asia/Kolkata"});
  document.getElementById('time').innerText = `India Time: ${indiaTime}`;
}

// Initialize charts
const uptimeChart = new Chart(document.getElementById('uptimeChart').getContext('2d'), {
  type:'line',
  data:{labels:[], datasets:[]},
  options:{responsive:true, plugins:{legend:{display:true}}}
});
const responseChart = new Chart(document.getElementById('responseChart').getContext('2d'), {
  type:'line',
  data:{labels:[], datasets:[]},
  options:{responsive:true, plugins:{legend:{display:true}}}
});

// Refresh
setInterval(loadStatus, 5000);
setInterval(updateTime, 1000);
loadStatus();
updateTime();
</script>

</body>
</html>
