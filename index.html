<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cinepolis Status Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; margin: 0; padding: 0; }
  header { background: #007BFF; color: #fff; padding: 1rem; text-align: center; }
  main { padding: 1rem; max-width: 800px; margin: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #ddd; }
  th { background: #f0f0f0; }
  .status-up { color: green; font-weight: bold; }
  .status-down { color: red; font-weight: bold; }
</style>
</head>
<body>
<header>
  <h1>Cinepolis Website Status</h1>
</header>
<main>
  <table>
    <thead>
      <tr>
        <th>Website</th>
        <th>Status</th>
        <th>Response Time (ms)</th>
        <th>Uptime %</th>
      </tr>
    </thead>
    <tbody id="status-table">
      <tr><td colspan="4">Loading status...</td></tr>
    </tbody>
  </table>
</main>

<script>
// Telegram bot details
const TELEGRAM_TOKEN = "YOUR_BOT_TOKEN"; // replace with your bot token
const TELEGRAM_CHAT_ID = "YOUR_CHAT_ID"; // replace with your chat id

// Keep track of previous statuses
let previousStatus = {};

// Function to send Telegram message
async function sendTelegramMessage(message) {
  const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}`;
  try {
    await fetch(url);
  } catch (err) {
    console.error("Telegram send error:", err);
  }
}

// Load status.json and update table
async function loadStatus() {
  const table = document.getElementById('status-table');
  table.innerHTML = '<tr><td colspan="4">Loading status...</td></tr>';

  try {
    const response = await fetch('status.json', { cache: "no-store" });
    if (!response.ok) throw new Error('Failed to fetch status.json');

    const data = await response.json();
    table.innerHTML = ''; // clear table

    data.forEach(site => {
      const tr = document.createElement('tr');
      const statusClass = site.status.toLowerCase() === 'up' ? 'status-up' : 'status-down';
      tr.innerHTML = `
        <td>${site.website}</td>
        <td class="${statusClass}">${site.status}</td>
        <td>${site.response_time}</td>
        <td>${site.uptime}</td>
      `;
      table.appendChild(tr);

      // Check for status change and send alert
      if (previousStatus[site.website] !== site.status) {
        const oldStatus = previousStatus[site.website] || 'UNKNOWN';
        previousStatus[site.website] = site.status;

        if (oldStatus !== 'UNKNOWN') {
          if (site.status.toLowerCase() === 'down') {
            sendTelegramMessage(`⚠️ ALERT: ${site.website} is DOWN!`);
          } else if (site.status.toLowerCase() === 'up') {
            sendTelegramMessage(`✅ RECOVERY: ${site.website} is back UP!`);
          }
        }
      }
    });

  } catch (err) {
    table.innerHTML = `<tr><td colspan="4" style="color:red;">Error loading status.json: ${err.message}</td></tr>`;
    console.error(err);
  }
}

// Initial load
loadStatus();
// Refresh every 60 seconds
setInterval(loadStatus, 60000);
</script>
</body>
</html>
