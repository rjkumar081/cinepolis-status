name: Cinepolis Uptime Monitor

on:
  schedule:
    - cron: '*/5 * * * *'   # har 5 minute me run kare
  workflow_dispatch:         # manual trigger option

jobs:
  check-uptime:
    runs-on: ubuntu-latest
    env:
      STATUS_FILE: status.json
      URL: https://www.cinepolis.com/in
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup curl
        run: sudo apt-get install -y curl

      - name: Check website status
        id: status
        run: |
          RESPONSE=$(curl -o /dev/null -s -w "%{http_code}" $URL)
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" $URL)
          if [ "$RESPONSE" -eq 200 ]; then
            STATUS="UP"
          else
            STATUS="DOWN"
          fi
          echo "STATUS=$STATUS" >> $GITHUB_ENV
          echo "STATUS_CODE=$RESPONSE" >> $GITHUB_ENV
          echo "RESPONSE_TIME=$RESPONSE_TIME" >> $GITHUB_ENV
          
          # Update status.json
          echo "{\"status\":\"$STATUS\",\"status_code\":$RESPONSE,\"response_time\":$RESPONSE_TIME}" > $STATUS_FILE

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add $STATUS_FILE

          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Uptime Check: $STATUS ($STATUS_CODE)"
            git push https://$GITHUB_TOKEN@github.com/${{ github.repository }} HEAD:main
          fi
