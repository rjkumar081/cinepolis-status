name: Cinepolis Uptime Monitor

on:
  schedule:
    - cron: "*/10 * * * *"   # à¤¹à¤° 10 à¤®à¤¿à¤¨à¤Ÿ
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: |
          npm install fs-extra

      - name: HTTP check with curl
        id: check_site
        run: |
          node <<'EOF'
          const { execSync } = require("child_process");
          const fs = require("fs-extra");

          const STATUS_FILE = "status.json";
          const LOG_FILE = "log.json";
          const URL = "https://www.cinepolis.com/in";
          const MAX_LOG = 1440;

          let status = "DOWN";
          let statusCode = 0;
          let responseTime = 0;

          try {
            const start = Date.now();

            const cmd =
              `curl -I -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" ` +
              `-H "Accept-Language: en-US,en;q=0.9" ` +
              `--connect-timeout 15 --max-time 20 -k -s ${URL}`;

            const output = execSync(cmd).toString();
            responseTime = Date.now() - start;

            const match = output.match(/HTTP\/[\d.]+\s+(\d+)/);
            if (match) {
              statusCode = parseInt(match[1], 10);
            }

            // IMPORTANT:
            // Curl command à¤¸à¤«à¤² à¤šà¤²à¤¾ à¤®à¤¤à¤²à¤¬ TCP connect + HTTP response à¤®à¤¿à¤² à¤—à¤¯à¤¾
            // => infra UP à¤¹à¥ˆ, Cloudflare 403 à¤†à¤ à¤¤à¥‹ à¤­à¥€ "UP"
            status = "UP";

          } catch (err) {
            console.log("curl error:", err.message);
            status = "DOWN";
          }

          (async () => {
            // à¤ªà¥à¤°à¤¾à¤¨à¤¾ log à¤ªà¤¢à¤¼à¥‹
            let log = [];
            if (await fs.pathExists(LOG_FILE)) {
              try {
                const raw = await fs.readFile(LOG_FILE, "utf8");
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) log = parsed;
              } catch {
                log = [];
              }
            }

            const entry = {
              checked_at: new Date().toISOString(),
              status,
              status_code: statusCode,
              response_time: responseTime
            };

            log.push(entry);
            if (log.length > MAX_LOG) log = log.slice(-MAX_LOG);

            const upCount = log.filter(e => e.status === "UP").length;
            const uptimePercent = ((upCount / log.length) * 100).toFixed(2);
            const prevStatus = log.length > 1 ? log[log.length - 2].status : "";

            await fs.writeJson(
              STATUS_FILE,
              {
                ...entry,
                uptime_24h: uptimePercent
              },
              { spaces: 2 }
            );
            await fs.writeJson(LOG_FILE, log, { spaces: 2 });

            const outputs = {
              status,
              status_code: statusCode,
              response_time: responseTime,
              uptime_percent: uptimePercent,
              prev_status: prevStatus
            };

            let out = "";
            for (const [k, v] of Object.entries(outputs)) {
              out += `${k}=${v}\n`;
            }
            fs.appendFileSync(process.env.GITHUB_OUTPUT, out);
          })().catch(err => {
            console.error("Monitor failed:", err);
            process.exit(1);
          });
          EOF

      - name: Telegram Alert (every 10 minutes)
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ steps.check_site.outputs.status }}"
          CODE="${{ steps.check_site.outputs.status_code }}"
          RESP="${{ steps.check_site.outputs.response_time }}"
          UPTIME="${{ steps.check_site.outputs.uptime_percent }}"

          echo "STATUS=${STATUS}"
          echo "CODE=${CODE}"
          echo "RESP=${RESP}"
          echo "UPTIME=${UPTIME}"

          if [ "$STATUS" = "UP" ]; then
            ICON="âœ…"
          else
            ICON="ðŸš¨"
          fi

          MSG="${ICON} *Cinepolis Status* ${ICON}%0A*URL:* https://www.cinepolis.com/in%0A*Status:* ${STATUS}%0A*HTTP Code:* ${CODE}%0A*Response Time:* ${RESP}ms%0A*Uptime (24h):* ${UPTIME}%"

          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            --data-urlencode "text=${MSG}" \
            -d parse_mode="Markdown"

      - name: Commit status.json and log.json
        run: |
          if git status --porcelain | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add status.json log.json || true
            git commit -m "chore: update uptime status [skip ci]" || echo "No changes to commit"
            git push
          else
            echo "No changes to commit"
          fi
