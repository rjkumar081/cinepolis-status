name: Cinepolis Uptime Monitor (Hybrid)

on:
  schedule:
    - cron: "*/10 * * * *"   # à¤¹à¤° 10 à¤®à¤¿à¤¨à¤Ÿ
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: |
          npm install fs-extra puppeteer

      - name: Real browser check + screenshot
        id: check_site
        run: |
          node <<'EOF'
          const fs = require("fs-extra");
          const puppeteer = require("puppeteer");

          const URL = "https://www.cinepolis.com/in";
          const STATUS_FILE = "status.json";
          const LOG_FILE = "log.json";
          const SCREENSHOT_FILE = "latest_screenshot.png";
          const MAX_LOG = 1440;

          async function main() {
            let status = "DOWN";      // final status
            let statusCode = 0;
            let responseTime = 0;
            let keywordFound = false;
            let errorMessage = "";

            const browser = await puppeteer.launch({
              headless: "new",
              args: ["--no-sandbox", "--disable-setuid-sandbox"]
            });

            try {
              const page = await browser.newPage();
              await page.setUserAgent(
                "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
              );
              await page.setExtraHTTPHeaders({
                "Accept-Language": "en-US,en;q=0.9"
              });

              const start = Date.now();
              const response = await page.goto(URL, {
                waitUntil: "domcontentloaded",
                timeout: 30000
              });
              responseTime = Date.now() - start;

              if (response) {
                statusCode = response.status();
              }

              // thoda wait for dynamic content
              await page.waitForTimeout(3000);

              const html = await page.content();
              const lower = html.toLowerCase();
              keywordFound =
                lower.includes("cinepolis") || lower.includes("cinÃ©polis");

              // screenshot proof
              await page.screenshot({
                path: SCREENSHOT_FILE,
                fullPage: true
              });

            } catch (err) {
              console.log("puppeteer error:", err.message);
              errorMessage = err.message;
            } finally {
              await browser.close();
            }

            // ---------- Decide STATUS ----------
            if (statusCode >= 200 && statusCode < 400 && keywordFound) {
              status = "UP";               // page loaded & brand text found
            } else if (statusCode >= 200 && statusCode < 400 && !keywordFound) {
              status = "UNKNOWN";          // response OK but content suspect
            } else if (statusCode === 403 || statusCode === 401) {
              status = "BLOCKED";          // WAF / auth issue
            } else if (statusCode > 0) {
              status = "ERROR";            // 4xx/5xx
            } else {
              status = "DOWN";             // no HTTP response at all
            }

            // ---------- Load previous log ----------
            let log = [];
            if (await fs.pathExists(LOG_FILE)) {
              try {
                const raw = await fs.readFile(LOG_FILE, "utf8");
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) log = parsed;
              } catch {
                log = [];
              }
            }

            const entry = {
              checked_at: new Date().toISOString(),
              status,
              status_code: statusCode,
              response_time: responseTime,
              keyword_found: keywordFound,
              error: errorMessage || null
            };

            log.push(entry);
            if (log.length > MAX_LOG) log = log.slice(-MAX_LOG);

            const upCount = log.filter(e => e.status === "UP").length;
            const uptimePercent =
              log.length > 0
                ? ((upCount / log.length) * 100).toFixed(2)
                : "0.00";
            const prevStatus =
              log.length > 1 ? log[log.length - 2].status : "";

            await fs.writeJson(
              STATUS_FILE,
              {
                ...entry,
                uptime_24h: uptimePercent
              },
              { spaces: 2 }
            );
            await fs.writeJson(LOG_FILE, log, { spaces: 2 });

            const outputs = {
              status,
              status_code: statusCode,
              response_time: responseTime,
              uptime_percent: uptimePercent,
              prev_status: prevStatus,
              keyword_found: keywordFound
            };

            let out = "";
            for (const [k, v] of Object.entries(outputs)) {
              out += `${k}=${v}\n`;
            }
            fs.appendFileSync(process.env.GITHUB_OUTPUT, out);
          }

          main().catch(err => {
            console.error("Monitor failed:", err);
            process.exit(1);
          });
          EOF

      - name: Telegram Alert with screenshot (every 10 minutes)
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ steps.check_site.outputs.status }}"
          CODE="${{ steps.check_site.outputs.status_code }}"
          RESP="${{ steps.check_site.outputs.response_time }}"
          UPTIME="${{ steps.check_site.outputs.uptime_percent }}"
          KEYWORD="${{ steps.check_site.outputs.keyword_found }}"

          echo "STATUS=${STATUS}"
          echo "CODE=${CODE}"
          echo "RESP=${RESP}"
          echo "UPTIME=${UPTIME}"
          echo "KEYWORD_FOUND=${KEYWORD}"

          if [ "$STATUS" = "UP" ]; then
            ICON="âœ…"
          else
            ICON="ðŸš¨"
          fi

          CAPTION="${ICON} Cinepolis Status ${ICON}\nURL: https://www.cinepolis.com/in\nStatus: ${STATUS} (HTTP ${CODE})\nKeyword found: ${KEYWORD}\nResponse: ${RESP} ms\nUptime (24h): ${UPTIME}%"

          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendPhoto" \
            -F chat_id="${CHAT_ID}" \
            -F photo="@latest_screenshot.png" \
            --form-string "caption=${CAPTION}"

      - name: Commit status.json, log.json and screenshot
        run: |
          if git status --porcelain | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add status.json log.json latest_screenshot.png || true
            git commit -m "chore: update hybrid uptime status [skip ci]" || echo "No changes to commit"
            git push
          else
            echo "No changes to commit"
          fi
