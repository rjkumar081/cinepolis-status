- name: Check Website Status for 3 minutes
  run: |
    node <<'EOF'
const puppeteer = require('puppeteer');
const fs = require('fs');
const axios = require('axios');

const STATUS_FILE = 'status.json';
const URL = 'https://www.cinepolis.com/in';
const MAX_LOG = 1440; // last 24h
const DURATION_MS = 3 * 60 * 1000; // 3 minutes

(async () => {
  let log = [];
  const startTime = Date.now();

  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox','--disable-setuid-sandbox','--disable-dev-shm-usage']
  });
  const page = await browser.newPage();

  while (Date.now() - startTime < DURATION_MS) {
    let status = 'DOWN';
    let statusCode = 0;
    let responseTime = 0;

    try {
      const reqStart = Date.now();
      const response = await page.goto(URL, { waitUntil: 'networkidle2', timeout: 60000 });
      responseTime = Date.now() - reqStart;
      if (response && response.status() === 200) status = 'UP';
      statusCode = response ? response.status() : 0;
    } catch (err) {
      console.error('Error accessing site:', err.message);
    }

    // Add entry
    log.push({
      checked_at: new Date().toISOString(),
      status,
      status_code: statusCode,
      response_time: responseTime
    });

    // Wait 10 seconds before next check inside 3 minutes
    await new Promise(res => setTimeout(res, 10000));
  }

  await browser.close();

  // Save log
  let oldLog = [];
  if (fs.existsSync(STATUS_FILE)) {
    try {
      oldLog = JSON.parse(fs.readFileSync(STATUS_FILE, 'utf8'));
    } catch {}
  }
  const combinedLog = [...oldLog, ...log].slice(-MAX_LOG);
  fs.writeFileSync(STATUS_FILE, JSON.stringify(combinedLog, null, 2));

  // Calculate uptime %
  const upCount = combinedLog.filter(e => e.status === 'UP').length;
  const uptimePercent = ((upCount / combinedLog.length) * 100).toFixed(2);

  // Send Telegram alert
  const TOKEN = process.env.TELEGRAM_BOT_TOKEN;
  const CHAT_ID = process.env.TELEGRAM_CHAT_ID;
  const lastStatus = log[log.length - 1];

  const MSG = lastStatus.status === 'UP'
    ? `âœ… *Website is UP!* âœ…%0A*URL:* ${URL}%0A*Response Time:* ${lastStatus.response_time}ms%0A*Uptime (24h):* ${uptimePercent}%`
    : `ðŸš¨ *Website DOWN!* ðŸš¨%0A*URL:* ${URL}%0A*Status Code:* ${lastStatus.status_code}%0A*Response Time:* ${lastStatus.response_time}ms%0A*Uptime (24h):* ${uptimePercent}%`;

  await axios.post(`https://api.telegram.org/bot${TOKEN}/sendMessage`, null, {
    params: { chat_id: CHAT_ID, text: MSG, parse_mode: 'Markdown' }
  });

})();
EOF
