name: Cinepolis Uptime Monitor

on:
  schedule:
    - cron: "*/10 * * * *"   # every 10 minutes
  workflow_dispatch:

jobs:
  monitor:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install fs-extra

      - name: Check Website Status and Update JSON
        id: check_site
        run: |
          node <<'EOF'
          const { execSync } = require("child_process");
          const fs = require("fs-extra");
          const path = require("path");

          const STATUS_FILE = path.join("status.json");  // latest status
          const LOG_FILE = path.join("log.json");        // history
          const URL = "https://www.cinepolis.com/in";
          const MAX_LOG = 1440; // 24h if every 1 min, 10-min interval à¤ªà¥‡ approx 10 à¤¦à¤¿à¤¨

          let status = "DOWN";
          let statusCode = 0;
          let responseTime = 0;

          try {
            const start = Date.now();

            // Curl with Chrome fingerprint (Cloudflare bypass)
            const cmd =
              `curl -I -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" ` +
              `-H "Accept-Language: en-US,en;q=0.9" ` +
              `--connect-timeout 15 --max-time 20 -k -s ${URL}`;

            const output = execSync(cmd).toString();
            responseTime = Date.now() - start;

            const match = output.match(/HTTP\/[\d.]+\s+(\d+)/);
            if (match) {
              statusCode = parseInt(match[1], 10);
              if ([200, 301, 302].includes(statusCode)) {
                status = "UP";
              }
            }

          } catch (err) {
            console.log("curl error:", err.message);
          }

          (async () => {
            // LOG: array of entries
            let log = [];
            if (await fs.pathExists(LOG_FILE)) {
              try {
                log = JSON.parse(await fs.readFile(LOG_FILE, "utf8")) || [];
                if (!Array.isArray(log)) log = [];
              } catch {
                log = [];
              }
            }

            const entry = {
              checked_at: new Date().toISOString(),
              status,
              status_code: statusCode,
              response_time: responseTime
            };

            log.push(entry);
            if (log.length > MAX_LOG) log = log.slice(-MAX_LOG);

            const upPct = (
              (log.filter(e => e.status === "UP").length / log.length) *
              100
            ).toFixed(2);

            // previous status (second last entry)
            let prevStatus = "";
            if (log.length >= 2) {
              prevStatus = log[log.length - 2].status || "";
            }

            // status.json -> à¤¸à¤¿à¤°à¥à¤« latest summary
            const latestStatus = {
              checked_at: entry.checked_at,
              status,
              status_code: statusCode,
              response_time: responseTime,
              uptime_24h: upPct
            };

            await fs.writeJson(STATUS_FILE, latestStatus, { spaces: 2 });
            await fs.writeJson(LOG_FILE, log, { spaces: 2 });

            // env vars (optional)
            const envLines = [
              `STATUS=${status}`,
              `STATUS_CODE=${statusCode}`,
              `UPTIME_PERCENT=${upPct}`,
              `RESPONSE_TIME=${responseTime}`,
              `PREV_STATUS=${prevStatus}`,
            ].join("\\n") + "\\n";
            fs.appendFileSync(process.env.GITHUB_ENV, envLines);

            // step outputs (for if: conditions)
            const outputLines = [
              `status=${status}`,
              `status_code=${statusCode}`,
              `uptime_percent=${upPct}`,
              `response_time=${responseTime}`,
              `prev_status=${prevStatus}`,
            ].join("\\n") + "\\n";
            fs.appendFileSync(process.env.GITHUB_OUTPUT, outputLines);
          })().catch(err => {
            console.error("Monitor error:", err);
            process.exit(1);
          });
          EOF

      - name: Telegram Alert - DOWN
        if: ${{ steps.check_site.outputs.status != 'UP' }}
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STATUS_CODE: ${{ steps.check_site.outputs.status_code }}
          RESPONSE_TIME: ${{ steps.check_site.outputs.response_time }}
          UPTIME_PERCENT: ${{ steps.check_site.outputs.uptime_percent }}
        run: |
          MSG="ðŸš¨ *Website DOWN!* ðŸš¨%0A*URL:* https://www.cinepolis.com/in%0A*Status Code:* ${STATUS_CODE}%0A*Response Time:* ${RESPONSE_TIME}ms%0A*Uptime (24h):* ${UPTIME_PERCENT}%"
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            --data-urlencode "text=${MSG}" \
            -d parse_mode="Markdown"

      - name: Telegram Alert - UP (if previously DOWN)
        if: ${{ and(eq(steps.check_site.outputs.status, 'UP'), ne(steps.check_site.outputs.prev_status, 'UP')) }}
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RESPONSE_TIME: ${{ steps.check_site.outputs.response_time }}
          UPTIME_PERCENT: ${{ steps.check_site.outputs.uptime_percent }}
        run: |
          MSG="âœ… *Website is UP!* âœ…%0A*URL:* https://www.cinepolis.com/in%0A*Response Time:* ${RESPONSE_TIME}ms%0A*Uptime (24h):* ${UPTIME_PERCENT}%"
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            --data-urlencode "text=${MSG}" \
            -d parse_mode="Markdown"

      - name: Commit status.json and log.json
        run: |
          if git status --porcelain | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add status.json log.json || true
            git commit -m "chore: update uptime status [skip ci]" || echo "No changes to commit"
            git push
          else
            echo "No changes to commit"
          fi
