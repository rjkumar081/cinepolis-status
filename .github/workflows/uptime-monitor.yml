name: Cinepolis Uptime Monitor

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  monitor:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm init -y
          npm install fs-extra

      - name: Check Website Status and Update status.json
        id: check_site
        run: |
          node <<'EOF'
const { execSync } = require("child_process");
const fs = require("fs-extra");
const path = require("path");

const ROOT_STATUS_FILE = path.join("public", "status.json");
const LOG_FOLDER = path.join("public", "logs");
const URL = "https://www.cinepolis.com/in";
const MAX_LOG = 1440;
const FAILURE_TOLERANCE = 1;

let status = "DOWN";
let statusCode = 0;
let responseTime = 0;

try {
  const start = Date.now();
  const cmd = `curl -L -s -o /dev/null -w "%{http_code}" -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" --connect-timeout 15 --max-time 25 ${URL}`;
  statusCode = parseInt(execSync(cmd).toString());
  responseTime = Date.now() - start;
  if (statusCode >= 200 && statusCode < 400) status = "UP";
} catch (err) {
  console.log("curl error:", err.message);
}

(async () => {
  await fs.ensureDir(LOG_FOLDER);
  let log = [];
  if (await fs.pathExists(ROOT_STATUS_FILE)) {
    try { log = JSON.parse(await fs.readFile(ROOT_STATUS_FILE, "utf8")) || []; } 
    catch { log = []; }
  }
  const entry = { checked_at: new Date().toISOString(), status, status_code: statusCode, response_time: responseTime };
  log.push(entry);
  if (log.length > MAX_LOG) log = log.slice(-MAX_LOG);

  const recent = log.slice(-FAILURE_TOLERANCE-1);
  const failCount = recent.filter(e => e.status !== "UP").length;
  const finalStatus = (failCount > FAILURE_TOLERANCE) ? "DOWN" : "UP";
  const upPct = ((log.filter(e => e.status === "UP").length / log.length) * 100).toFixed(2);

  await fs.writeJson(ROOT_STATUS_FILE, log, { spaces: 2 });
  await fs.writeJson(path.join(LOG_FOLDER, `${Date.now()}.json`), entry, { spaces: 2 });

  fs.appendFileSync(process.env.GITHUB_ENV, `STATUS=${finalStatus}\n`);
  fs.appendFileSync(process.env.GITHUB_ENV, `STATUS_CODE=${statusCode}\n`);
  fs.appendFileSync(process.env.GITHUB_ENV, `UPTIME_PERCENT=${upPct}\n`);
  fs.appendFileSync(process.env.GITHUB_ENV, `RESPONSE_TIME=${responseTime}\n`);
})();
EOF

      - name: Telegram Alert - DOWN
        if: ${{ env.STATUS != 'UP' }}
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          MSG="ðŸš¨ *Website DOWN!* ðŸš¨%0A*URL:* https://www.cinepolis.com/in%0A*Status Code:* ${{ env.STATUS_CODE }}%0A*Response Time:* ${{ env.RESPONSE_TIME }}ms%0A*Uptime (24h):* ${{ env.UPTIME_PERCENT }}%"
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            --data-urlencode "text=$MSG" \
            -d parse_mode="Markdown"

      - name: Telegram Alert - UP (if previously DOWN)
        if: ${{ env.STATUS == 'UP' }}
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          if [ -f public/status.json ]; then
            PREV_STATUS=$(jq -r '.[-2].status // "UP"' public/status.json)
          else
            PREV_STATUS="UP"
          fi
          if [ -z "$PREV_STATUS" ]; then
            PREV_STATUS="UP"
          fi
          if [ "$PREV_STATUS" != "UP" ]; then
            MSG="âœ… *Website is UP!* âœ…%0A*URL:* https://www.cinepolis.com/in%0A*Response Time:* ${{ env.RESPONSE_TIME }}ms%0A*Uptime (24h):* ${{ env.UPTIME_PERCENT }}%"
            curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode "text=$MSG" \
              -d parse_mode="Markdown"
