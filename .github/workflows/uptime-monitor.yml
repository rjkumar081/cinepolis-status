name: Cinepolis Uptime Monitor

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Check Website Status and Update status.json
        shell: bash
        run: |
          node -e "
const fs = require('fs').promises;
const path = require('path');
const { execSync } = require('child_process');

const ROOT_STATUS_FILE = path.join('public','status.json');
const LOG_FOLDER = path.join('public','logs');
const URL = 'https://www.cinepolis.com/in';
const MAX_LOG = 1440;
const FAILURE_TOLERANCE = 1;

(async () => {
  await fs.mkdir(LOG_FOLDER, { recursive: true });

  let status='DOWN', statusCode=0, responseTime=0;
  try {
    const start = Date.now();
    const cmd = \`curl -L -s -o /dev/null -w \"%{http_code}\" -A 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36' --connect-timeout 15 --max-time 25 ${URL}\`;
    statusCode = parseInt(execSync(cmd).toString());
    responseTime = Date.now() - start;
    if(statusCode>=200 && statusCode<400) status='UP';
  } catch(e){ console.log('curl error:', e.message); }

  let log=[];
  try { log = JSON.parse(await fs.readFile(ROOT_STATUS_FILE,'utf8')) || []; } catch {}

  const entry = { checked_at: new Date().toISOString(), status, status_code: statusCode, response_time: responseTime };
  log.push(entry);
  if(log.length>MAX_LOG) log = log.slice(-MAX_LOG);

  const recent = log.slice(-FAILURE_TOLERANCE-1);
  const failCount = recent.filter(e => e.status!=='UP').length;
  const finalStatus = (failCount > FAILURE_TOLERANCE)?'DOWN':'UP';

  const upPct = ((log.filter(e => e.status==='UP').length/log.length)*100).toFixed(2);

  await fs.writeFile(ROOT_STATUS_FILE, JSON.stringify(log,null,2));
  await fs.writeFile(path.join(LOG_FOLDER, \`\${Date.now()}.json\`), JSON.stringify(entry,null,2));

  require('fs').appendFileSync(process.env.GITHUB_ENV,
    \`STATUS=${finalStatus}\nSTATUS_CODE=${statusCode}\nUPTIME_PERCENT=${upPct}\nRESPONSE_TIME=${responseTime}\n\`
  );
})();
"

      - name: Telegram Alert - DOWN
        if: ${{ env.STATUS != 'UP' }}
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          MSG="ðŸš¨ *Website DOWN!* ðŸš¨%0A*URL:* https://www.cinepolis.com/in%0A*Status Code:* ${{ env.STATUS_CODE }}%0A*Response Time:* ${{ env.RESPONSE_TIME }}ms%0A*Uptime (24h):* ${{ env.UPTIME_PERCENT }}%"
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            --data-urlencode "text=$MSG" \
            -d parse_mode="Markdown"

      - name: Telegram Alert - UP
        if: ${{ env.STATUS == 'UP' }}
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          if [ -f public/status.json ]; then
            PREV_STATUS=$(jq -r '.[-2].status // "UP"' public/status.json)
          else
            PREV_STATUS="UP"
          fi
          if [ -z "$PREV_STATUS" ]; then
            PREV_STATUS="UP"
          fi
          if [ "$PREV_STATUS" != "UP" ]; then
            MSG="âœ… *Website is UP!* âœ…%0A*URL:* https://www.cinepolis.com/in%0A*Response Time:* ${{ env.RESPONSE_TIME }}ms%0A*Uptime (24h):* ${{ env.UPTIME_PERCENT }}%"
            curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode "text=$MSG" \
              -d parse_mode="Markdown"
