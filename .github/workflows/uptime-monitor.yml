name: Cinepolis Uptime Monitor

on:
  schedule:
    - cron: '*/5 * * * *'  # har 5 minute me run
  workflow_dispatch:       # manual trigger

jobs:
  check-uptime:
    runs-on: ubuntu-latest
    env:
      STATUS_FILE: status.json
      URL: https://www.cinepolis.com/in
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHATID: ${{ secrets.TELEGRAM_CHATID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Check website status
        id: status
        run: |
          RESPONSE=$(curl -o /dev/null -s -w "%{http_code}" $URL)
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" $URL)
          
          if [ "$RESPONSE" -eq 200 ]; then
            STATUS="UP"
          else
            STATUS="DOWN"
          fi

          # Save current status in env
          echo "STATUS=$STATUS" >> $GITHUB_ENV
          echo "STATUS_CODE=$RESPONSE" >> $GITHUB_ENV
          echo "RESPONSE_TIME=$RESPONSE_TIME" >> $GITHUB_ENV

          # Read previous status if exists
          if [ -f $STATUS_FILE ]; then
            PREV_STATUS=$(jq -r '.status' $STATUS_FILE)
          else
            PREV_STATUS=""
          fi

          # Update status.json
          echo "{\"status\":\"$STATUS\",\"status_code\":$RESPONSE,\"response_time\":$RESPONSE_TIME}" > $STATUS_FILE

          # Export previous status for later steps
          echo "PREV_STATUS=$PREV_STATUS" >> $GITHUB_ENV

      - name: Commit and push changes if status changed
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add $STATUS_FILE

          if [ "$STATUS" != "$PREV_STATUS" ]; then
            git commit -m "Uptime Check: $STATUS ($STATUS_CODE)"
            git push https://$GITHUB_TOKEN@github.com/${{ github.repository }} HEAD:main
          else
            echo "No changes in status, skipping commit."
          fi

      - name: Send Telegram notification if status changed or DOWN
        if: always()
        run: |
          # Send alert only if status changed or DOWN
          if [ "$STATUS" != "$PREV_STATUS" ] || [ "$STATUS" = "DOWN" ]; then
            MESSAGE="Cinepolis Uptime Status: $STATUS
Status Code: $STATUS_CODE
Response Time: ${RESPONSE_TIME}s"

            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
                 -d chat_id=$TELEGRAM_CHATID \
                 -d text="$MESSAGE"
          else
            echo "Status unchanged and UP, no Telegram message sent."
          fi
