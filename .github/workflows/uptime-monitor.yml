name: Cinepolis Uptime Monitor

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  monitor:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install fs-extra

      - name: Check Website Status and Update status.json (ESM FIX)
        id: check_site
        run: |
          node <<'EOF'
          import { execSync } from "child_process";
          import fs from "fs-extra";
          import path from "path";

          const ROOT = "public/status.json";
          const LOG_DIR = "public/logs";
          const URL = "https://www.cinepolis.com/in";

          async function main() {
            await fs.ensureFile(ROOT);
            await fs.ensureDir(LOG_DIR);

            // Load old logs
            let log = [];
            try {
              const raw = await fs.readFile(ROOT, "utf8");
              log = raw.trim() ? JSON.parse(raw) : [];
            } catch {
              log = [];
            }

            let status = "DOWN";
            let statusCode = 0;
            let responseTime = 0;

            try {
              const start = Date.now();
              const cmd = `curl -I -s -k --max-time 20 ${URL}`;
              const output = execSync(cmd).toString();
              responseTime = Date.now() - start;

              const match = output.match(/HTTP\/[\d.]+ (\d+)/);
              if (match) {
                statusCode = Number(match[1]);
                if ([200, 301, 302].includes(statusCode)) status = "UP";
              }
            } catch (e) {
              console.log("curl failed");
            }

            const entry = {
              checked_at: new Date().toISOString(),
              status,
              status_code: statusCode,
              response_time: responseTime
            };

            log.push(entry);
            if (log.length > 1440) log = log.slice(-1440);

            await fs.writeJson(ROOT, log, { spaces: 2 });
            await fs.writeJson(path.join(LOG_DIR, `${Date.now()}.json`), entry, {
              spaces: 2,
            });

            const upPct = ((log.filter(e => e.status === "UP").length / log.length) * 100).toFixed(2);

            fs.appendFileSync(process.env.GITHUB_ENV, `STATUS=${status}\n`);
            fs.appendFileSync(process.env.GITHUB_ENV, `STATUS_CODE=${statusCode}\n`);
            fs.appendFileSync(process.env.GITHUB_ENV, `UPTIME_PERCENT=${upPct}\n`);
            fs.appendFileSync(process.env.GITHUB_ENV, `RESPONSE_TIME=${responseTime}\n`);
          }

          main();
          EOF

      - name: Telegram Alert - DOWN
        if: ${{ env.STATUS != 'UP' }}
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          MSG="ðŸš¨ *Website DOWN!* ðŸš¨%0A*URL:* https://www.cinepolis.com/in%0A*Status Code:* ${{ env.STATUS_CODE }}%0A*Response Time:* ${{ env.RESPONSE_TIME }}ms%0A*Uptime:* ${{ env.UPTIME_PERCENT }}%"
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            --data-urlencode "text=$MSG" \
            -d parse_mode="Markdown"

      - name: Telegram Alert - UP (if previously DOWN)
        if: ${{ env.STATUS == 'UP' }}
        run: |
          PREV_STATUS=$(jq -r '.[-2].status // ""' public/status.json || echo "")
          if [ "$PREV_STATUS" != "UP" ]; then
            TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
            CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
            MSG="âœ… *Website is UP!*%0A*URL:* https://www.cinepolis.com/in%0A*Response:* ${{ env.RESPONSE_TIME }}ms"
            curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              --data-urlencode "text=$MSG" \
              -d parse_mode="Markdown"
          fi
