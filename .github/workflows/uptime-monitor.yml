name: Cinepolis Uptime Monitor

on:
  schedule:
    - cron: "*/3 * * * *"   # every 3 minutes
  workflow_dispatch:

jobs:
  monitor:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm init -y
          npm install puppeteer jq

      - name: Check Website Status
        id: check_site
        run: |
          node <<'EOF'
const puppeteer = require('puppeteer');
const fs = require('fs');

const STATUS_FILE = 'status.json';
const URL = 'https://www.cinepolis.com/in';
const MAX_LOG = 1440; // last 24h of checks

(async () => {
  try {
    let status = 'DOWN';
    let statusCode = 0;
    let responseTime = 0;

    try {
      const startTime = Date.now();
      const browser = await puppeteer.launch({
        headless: true,
        args: ['--no-sandbox','--disable-setuid-sandbox','--disable-dev-shm-usage']
      });
      const page = await browser.newPage();
      const response = await page.goto(URL, { waitUntil: 'networkidle2', timeout: 60000 });
      responseTime = Date.now() - startTime;
      if (response && response.status() === 200) status = 'UP';
      statusCode = response ? response.status() : 0;
      await browser.close();
    } catch (err) {
      console.error('Error accessing site:', err.message);
    }

    // Read existing status.json safely
    let log = [];
    if (fs.existsSync(STATUS_FILE)) {
      try {
        const content = fs.readFileSync(STATUS_FILE, 'utf8');
        const parsed = JSON.parse(content);
        log = Array.isArray(parsed) ? parsed : [];
      } catch (err) {
        console.error("Invalid JSON, starting fresh log.");
        log = [];
      }
    }

    // Add new entry
    log.push({
      checked_at: new Date().toISOString(),
      status: status,
      status_code: statusCode,
      response_time: responseTime
    });

    // Keep last MAX_LOG entries only
    if (log.length > MAX_LOG) log = log.slice(-MAX_LOG);

    // Calculate uptime %
    const upCount = log.filter(e => e.status === 'UP').length;
    const uptimePercent = ((upCount / log.length) * 100).toFixed(2);

    // Save log
    fs.writeFileSync(STATUS_FILE, JSON.stringify(log, null, 2));

    // Export variables
    fs.appendFileSync(process.env.GITHUB_ENV, `STATUS=${status}\n`);
    fs.appendFileSync(process.env.GITHUB_ENV, `STATUS_CODE=${statusCode}\n`);
    fs.appendFileSync(process.env.GITHUB_ENV, `UPTIME_PERCENT=${uptimePercent}\n`);
    fs.appendFileSync(process.env.GITHUB_ENV, `RESPONSE_TIME=${responseTime}\n`);

  } catch (err) {
    console.error("Fatal error:", err);
    process.exit(0); // Prevent exit code 2
  }
})();
EOF

      # Telegram alerts and commit steps remain unchanged
