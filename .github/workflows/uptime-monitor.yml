name: Cinepolis Uptime Monitor

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  uptime:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Install Browser Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxss1 libnss3 libatk1.0-0 libcups2 \
            libx11-xcb1 libxcomposite1 libxrandr2 \
            libgbm-dev libasound2 libxdamage1 \
            libxext6 libxfixes3 libpangocairo-1.0-0

      - name: Install Packages
        run: npm install puppeteer fs-extra

      - name: Telegram Alert - Workflow Triggered
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          MSG="âš¡ *CinÃ©polis Uptime Monitor Started!*"
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" --data-urlencode "text=$MSG" -d parse_mode="Markdown"

      - name: Run Real Browser Uptime Check
        run: node monitor/real-check.js

      - name: Copy status.json to root
        run: cp public/status.json status.json

      - name: Commit Updated Status
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add status.json public/status.json
          if git diff --staged --quiet; then
            echo "No changes."
          else
            git commit -m "Updated uptime log"
            git push
          fi

      - name: UP/DOWN Telegram Alerts
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          STATUS=$(jq -r '.[-1].status' status.json)
          CODE=$(jq -r '.[-1].statusCode' status.json)
          TIME=$(jq -r '.[-1].responseTime' status.json)

          if [ "$STATUS" = "UP" ]; then
            MSG="ðŸŸ¢ *Website UP*\nStatus Code: $CODE\nResponse: ${TIME}ms"
          else
            MSG="ðŸ”´ *Website DOWN*\nStatus Code: $CODE\nResponse: ${TIME}ms"
          fi

          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" --data-urlencode "text=$MSG" -d parse_mode="Markdown"
