name: Cinepolis Uptime Monitor (REAL BROWSER)

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install fs-extra puppeteer

      - name: Real Browser Check (Puppeteer)
        id: check_site
        run: |
          node <<'EOF'
          const fs = require("fs-extra");
          const puppeteer = require("puppeteer");

          const STATUS_FILE = "status.json";
          const LOG_FILE = "log.json";
          const URL = "https://www.cinepolis.com/in";
          const MAX_LOG = 1440;

          let status = "DOWN";
          let statusCode = 0;
          let responseTime = 0;

          (async () => {
            const browser = await puppeteer.launch({
              headless: "new",
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });

            const page = await browser.newPage();
            const start = Date.now();

            try {
              const response = await page.goto(URL, {
                waitUntil: "domcontentloaded",
                timeout: 30000
              });

              responseTime = Date.now() - start;
              statusCode = response.status();

              if (statusCode >= 200 && statusCode < 400) {
                status = "UP";
              }
            } catch (err) {
              console.log("Browser error:", err.message);
            }

            await browser.close();

            let log = [];
            if (await fs.pathExists(LOG_FILE)) {
              try {
                log = JSON.parse(await fs.readFile(LOG_FILE, "utf8"));
                if (!Array.isArray(log)) log = [];
              } catch { log = []; }
            }

            const entry = {
              checked_at: new Date().toISOString(),
              status,
              status_code: statusCode,
              response_time: responseTime
            };

            log.push(entry);
            if (log.length > MAX_LOG) log = log.slice(-MAX_LOG);

            const uptime = ((log.filter(e => e.status === "UP").length / log.length) * 100).toFixed(2);
            const prevStatus = log.length > 1 ? log[log.length - 2].status : "";

            await fs.writeJson(STATUS_FILE, {
              ...entry,
              uptime_24h: uptime
            }, { spaces: 2 });

            await fs.writeJson(LOG_FILE, log, { spaces: 2 });

            fs.appendFileSync(process.env.GITHUB_OUTPUT,
              `status=${status}\nstatus_code=${statusCode}\nresponse_time=${responseTime}\nuptime_percent=${uptime}\nprev_status=${prevStatus}\n`
            );
          })();
          EOF

      - name: Telegram ALERT - DOWN
        if: ${{ steps.check_site.outputs.status != 'UP' }}
        env:
          TOKEN: $${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: $${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MSG="ðŸš¨ WEBSITE DOWN ðŸš¨%0AURL: https://www.cinepolis.com/in%0AStatus Code: ${{ steps.check_site.outputs.status_code }}%0AResponse Time: ${{ steps.check_site.outputs.response_time }}ms"
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
          -d chat_id="${CHAT_ID}" \
          --data-urlencode "text=${MSG}"

      - name: Telegram RECOVERY ALERT
        if: ${{ steps.check_site.outputs.status == 'UP' && steps.check_site.outputs.prev_status != 'UP' }}
        env:
          TOKEN: $${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: $${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MSG="âœ… WEBSITE RECOVERED âœ…%0AURL: https://www.cinepolis.com/in%0AResponse Time: ${{ steps.check_site.outputs.response_time }}ms"
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
          -d chat_id="${CHAT_ID}" \
          --data-urlencode "text=${MSG}"

      - name: Commit status files
        run: |
          if git status --porcelain | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions@github.com"
            git add status.json log.json
            git commit -m "Update real browser status"
            git push
          fi
