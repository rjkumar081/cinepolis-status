name: Cinepolis Uptime Monitor

on:
  schedule:
    - cron: "*/10 * * * *"   # à¤¹à¤° 10 à¤®à¤¿à¤¨à¤Ÿ
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install fs-extra puppeteer

      - name: Check site with real browser (Puppeteer)
        id: check_site
        run: |
          node <<'EOF'
          const fs = require('fs-extra');
          const puppeteer = require('puppeteer');

          const STATUS_FILE = 'status.json';
          const LOG_FILE = 'log.json';
          const URL = 'https://www.cinepolis.com/in';
          const MAX_LOG = 1440;

          async function main() {
            let status = 'DOWN';
            let statusCode = 0;
            let responseTime = 0;

            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox'],
            });

            try {
              const page = await browser.newPage();
              const start = Date.now();
              const response = await page.goto(URL, {
                waitUntil: 'domcontentloaded',
                timeout: 30000,
              });
              responseTime = Date.now() - start;
              statusCode = response.status();
              if (statusCode >= 200 && statusCode < 400) {
                status = 'UP';
              }
            } catch (err) {
              console.log('Browser error:', err.message);
            } finally {
              await browser.close();
            }

            // read existing log
            let log = [];
            if (await fs.pathExists(LOG_FILE)) {
              try {
                const raw = await fs.readFile(LOG_FILE, 'utf8');
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) log = parsed;
              } catch {
                log = [];
              }
            }

            const entry = {
              checked_at: new Date().toISOString(),
              status,
              status_code: statusCode,
              response_time: responseTime,
            };

            log.push(entry);
            if (log.length > MAX_LOG) log = log.slice(-MAX_LOG);

            const upCount = log.filter(e => e.status === 'UP').length;
            const uptimePercent = ((upCount / log.length) * 100).toFixed(2);
            const prevStatus = log.length > 1 ? log[log.length - 2].status : '';

            await fs.writeJson(
              STATUS_FILE,
              {
                ...entry,
                uptime_24h: uptimePercent,
              },
              { spaces: 2 }
            );
            await fs.writeJson(LOG_FILE, log, { spaces: 2 });

            const outputs = {
              status,
              status_code: statusCode,
              response_time: responseTime,
              uptime_percent: uptimePercent,
              prev_status: prevStatus,
            };

            let out = '';
            for (const [k, v] of Object.entries(outputs)) {
              out += `${k}=${v}\n`;
            }
            fs.appendFileSync(process.env.GITHUB_OUTPUT, out);
          }

          main().catch(err => {
            console.error('Monitor failed:', err);
            process.exit(1);
          });
          EOF

      - name: Telegram Alert (every 10 minutes)
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ steps.check_site.outputs.status }}"
          CODE="${{ steps.check_site.outputs.status_code }}"
          RESP="${{ steps.check_site.outputs.response_time }}"
          UPTIME="${{ steps.check_site.outputs.uptime_percent }}"

          if [ "$STATUS" = "UP" ]; then
            ICON="âœ…"
          else
            ICON="ðŸš¨"
          fi

          MSG="${ICON} *Cinepolis Status* ${ICON}%0A*URL:* https://www.cinepolis.com/in%0A*Status:* ${STATUS}%0A*HTTP Code:* ${CODE}%0A*Response Time:* ${RESP}ms%0A*Uptime (24h):* ${UPTIME}%"

          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            --data-urlencode "text=${MSG}" \
            -d parse_mode="Markdown"

      - name: Commit status.json and log.json
        run: |
          if git status --porcelain | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add status.json log.json || true
            git commit -m "chore: update uptime status [skip ci]" || echo "No changes to commit"
            git push
          else
            echo "No changes to commit"
          fi
