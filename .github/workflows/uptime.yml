name: Cinepolis Uptime Check

on:
  schedule:
    - cron: "* * * * *"
  workflow_dispatch:

jobs:
  uptime:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm init -y
          npm install puppeteer

      - name: Check Cinepolis Website in Headless Browser
        id: check_site
        run: |
          node <<'EOF'
          const puppeteer = require('puppeteer');

          (async () => {
            let status = 'DOWN';
            let statusCode = '0';
            try {
              const browser = await puppeteer.launch({ args: ['--no-sandbox', '--disable-setuid-sandbox'] });
              const page = await browser.newPage();
              const response = await page.goto('https://www.cinepolis.com/in', { waitUntil: 'networkidle2', timeout: 30000 });
              if (response) {
                statusCode = response.status();
                if (statusCode === 200) status = 'UP';
              }
              await browser.close();
            } catch (err) {
              console.log('Error accessing site:', err.message);
            }

            // write outputs using Environment Files
            require('fs').appendFileSync(process.env.GITHUB_ENV, `STATUS=${status}\n`);
            require('fs').appendFileSync(process.env.GITHUB_ENV, `STATUS_CODE=${statusCode}\n`);
          })();
          EOF

      - name: Telegram Alert - DOWN
        if: ${{ env.STATUS != 'UP' }}
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          STATUS_CODE="${{ env.STATUS_CODE }}"
          
          MSG="ðŸš¨ *Cinepolis Website DOWN!* ðŸš¨%0A*URL:* https://www.cinepolis.com/in%0A*Status Code:* $STATUS_CODE%0A*Repo:* ${{ github.repository }}"

          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            --data-urlencode "text=$MSG" \
            -d parse_mode="Markdown" || true

      - name: Update status.json and Commit
        run: |
          TIME_NOW=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          SITE_STATUS="${{ env.STATUS }}"
          STATUS_CODE="${{ env.STATUS_CODE }}"
          
          JSON_CONTENT=$(printf '{\n  "url": "https://www.cinepolis.com/in",\n  "status": "%s",\n  "status_code": "%s",\n  "checked_at": "%s"\n}' "$SITE_STATUS" "$STATUS_CODE" "$TIME_NOW")
          echo "$JSON_CONTENT" > status.json

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add status.json
          
          if git diff --staged --quiet; then
            echo "status.json has no changes. Skipping commit/push."
          else
            git commit -m "Uptime Check: $SITE_STATUS ($STATUS_CODE)"
            git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:main
            echo "Successfully committed and pushed status.json."
