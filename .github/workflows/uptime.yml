name: Cinepolis Status Alert

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check-status:
    runs-on: ubuntu-latest

    steps:
    - name: Download last status
      id: last
      uses: actions/download-artifact@v4
      with:
        name: last_status
        path: ./prev
      continue-on-error: true

    - name: Read last status
      run: |
        if [ -f "./prev/status.txt" ]; then
          LAST_STATUS=$(cat ./prev/status.txt)
        else
          LAST_STATUS="unknown"
        fi
        echo "LAST_STATUS=$LAST_STATUS" >> $GITHUB_ENV

    - name: Call Cinepolis Status API
      run: |
        RESPONSE=$(curl -s -X POST "https://cinepolis-status.onrender.com/check" \
          -H "x-api-key: ${{ secrets.CINE_API_KEY }}" \
          -H "Content-Type: application/json")

        # Encode HTML-safe
        ENCODED=$(echo "$RESPONSE" | base64)
        echo "API_RESPONSE=$ENCODED" >> $GITHUB_ENV

    - name: Decode and Extract Current Status
      run: |
        DECODED=$(echo "$API_RESPONSE" | base64 --decode)
        echo "API Response: $DECODED"

        CURRENT_STATUS=$(echo "$DECODED" | jq -r '.status')
        echo "CURRENT_STATUS=$CURRENT_STATUS" >> $GITHUB_ENV

    - name: Compare Status & Send Alert
      run: |
        if [ "$LAST_STATUS" != "$CURRENT_STATUS" ]; then
          
          if [ "$CURRENT_STATUS" = "down" ]; then
            MESSAGE="ğŸš¨ ALERT: Cinepolis website is DOWN âŒ"
          else
            MESSAGE="ğŸŸ¢ GOOD NEWS: Cinepolis website is UP âœ”ï¸"
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\"}"

        else
          echo "No change, no alert sent."
        fi

    - name: Save current status for next run
      uses: actions/upload-artifact@v4
      with:
        name: last_status
        path: status.txt
      run: |
        echo "$CURRENT_STATUS" > status.txt
