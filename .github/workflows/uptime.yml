name: Uptime Monitor

on:
  schedule:
    - cron: "*/5 * * * *"   # Runs every 5 minutes
  workflow_dispatch:

jobs:
  uptime-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Check website status
      id: ping
      run: |
        STATUS_CODE=$(curl -o /dev/null -s -w "%{http_code}\n" https://www.cinepolis.com/in)
        echo "STATUS_CODE=$STATUS_CODE" >> $GITHUB_ENV
        
        if [ "$STATUS_CODE" = "200" ]; then
          echo "WEBSITE_STATUS=UP" >> $GITHUB_ENV
        else
          echo "WEBSITE_STATUS=DOWN" >> $GITHUB_ENV
        fi

    - name: Update status JSON (for dashboard)
      run: |
        TIME_NOW=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        cat <<EOF > status.json
{
  "url": "https://www.cinepolis.com/in",
  "status": "${WEBSITE_STATUS}",
  "status_code": "${STATUS_CODE}",
  "checked_at": "${TIME_NOW}"
}
EOF

    - name: Commit status update
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add status.json
        git commit -m "Uptime update: ${WEBSITE_STATUS}" || echo "No changes to commit"
        git push

    - name: Send Telegram Alert
      if: env.WEBSITE_STATUS == 'DOWN'
      run: |
        MESSAGE="⚠️ Cinepolis Website DOWN!
Status Code: ${STATUS_CODE}
Checked At: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        
        curl -s -X POST "https://api.telegram.org/bot$8126378434:AAEQDXyBmz_lX8cOKLERiN3gBiRio9Zkjm4//sendMessage" \
        -d chat_id="$8421770138" \
        -d text="$MESSAGE"
