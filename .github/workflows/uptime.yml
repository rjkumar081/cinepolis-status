name: Uptime Monitor

on:
  schedule:
    - cron: "*/5 * * * *"   # Runs every 5 minutes
  workflow_dispatch:        # Allows manual run button
  push:
    paths:
      - ".github/workflows/uptime.yml"
      - ".uptimerc.yml"

permissions:
  contents: write
  actions: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Install Node & Upptime
        run: |
          npm install -g upptime@latest

      - name: Run Uptime Checks
        run: |
          upptime update

      - name: Configure Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Commit & Push Status Updates
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add .
          git commit -m "Update status logs" || echo "No changes to commit"
          git push https://x-access-token:${TOKEN}@github.com/rjkumar081/cinepolis-status.git

      # OPTIONAL: Slack Notifications
      - name: Slack Notification (optional)
        if: always()
        run: |
          if [ ! -z "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ðŸ”” Uptime check completed for cinepolis.com/in\"}" \
            ${{ secrets.SLACK_WEBHOOK }}
          fi

      # OPTIONAL: WhatsApp (Twilio API)
      - name: WhatsApp Notification (optional)
        if: always()
        run: |
          if [ ! -z "${{ secrets.TWILIO_SID }}" ]; then
            curl -X POST https://api.twilio.com/2010-04-01/Accounts/${{ secrets.TWILIO_SID }}/Messages.json \
            --data-urlencode "Body=Uptime Check Completed" \
            --data-urlencode "From=whatsapp:+14155238886" \
            --data-urlencode "To=whatsapp:${{ secrets.WHATSAPP_TO }}" \
            -u ${{ secrets.TWILIO_SID }}:${{ secrets.TWILIO_TOKEN }}
          fi
